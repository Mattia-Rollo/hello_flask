{% extends 'base.html' %} 

{% block title%} 
Vendi il Tuo Prodotto | Flask Market
{% endblock%} 

{% block content %}

<!-- Hero Section -->
<section class="py-5 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12 text-center">
                <h1 class="display-5 fw-bold mb-3">
                    <i class="fas fa-store me-3 text-primary"></i>Vendi il Tuo Prodotto
                </h1>
                <p class="lead text-muted mb-0">Raggiungi migliaia di potenziali acquirenti nella nostra community</p>
            </div>
        </div>
    </div>
</section>

<!-- Add Product Form -->
<section class="py-5">
    <div class="container">
        <div class="row">
            <!-- Form Section -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-4">
                        <h4 class="mb-0 fw-bold">
                            <i class="fas fa-edit me-2 text-primary"></i>Dettagli Prodotto
                        </h4>
                        <p class="text-muted mb-0 mt-1">Inserisci le informazioni del tuo prodotto</p>
                    </div>
                    <div class="card-body p-4">
                        <!-- FORM FLASK-WTF: Tutti i campi vengono dalla classe AddItemForm in app/forms.py -->
                        <!-- Per modificare etichette, validazioni, opzioni: modifica il file forms.py -->
                        <!-- form.hidden_tag() genera il token CSRF per la sicurezza -->
                        <form method="POST" enctype="multipart/form-data" novalidate id="productForm">
                            {{ form.hidden_tag() }}
                            
                            <!-- Product Name -->
                            <!-- NOTA: Le etichette dei campi (es. "Nome Prodotto:") vengono dal file app/forms.py -->
                            <!-- Classe AddItemForm, campo: name = StringField(label='Nome Prodotto:', ...) -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-tag me-2 text-primary"></i>{{ form.name.label.text }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.name(class="form-control form-control-lg", placeholder="es. iPhone 15 Pro, MacBook Air M2, Nike Air Max...", id="field-name") }}
                                <div class="invalid-feedback d-none" id="error-name">
                                    Errore nome
                                </div>
                                <div class="valid-feedback d-none" id="success-name">
                                    <i class="fas fa-check me-1"></i>Nome perfetto!
                                </div>
                                <div class="form-text">Un nome accattivante aiuta a vendere meglio il prodotto</div>
                            </div>

                            <!-- Price and Barcode -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-dollar-sign me-2 text-success"></i>{{ form.price.label.text }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group input-group-lg">
                                        <span class="input-group-text bg-success text-white">$</span>
                                        {{ form.price(class="form-control", placeholder="999", id="field-price") }}
                                    </div>
                                    <div class="invalid-feedback d-none" id="error-price">
                                        Errore prezzo
                                    </div>
                                    <div class="valid-feedback d-none" id="success-price">
                                        <i class="fas fa-check me-1"></i>Prezzo valido!
                                    </div>
                                    <div class="form-text">Prezzo competitivo per una vendita veloce</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-barcode me-2 text-info"></i>{{ form.barcode.label.text }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.barcode(class="form-control form-control-lg", placeholder="123456789012", id="field-barcode") }}
                                    <div class="invalid-feedback d-none" id="error-barcode">
                                        Errore codice
                                    </div>
                                    <div class="valid-feedback d-none" id="success-barcode">
                                        <i class="fas fa-check me-1"></i>Codice valido!
                                    </div>
                                    <div class="form-text">Esattamente 12 caratteri numerici</div>
                                </div>
                            </div>

                            <!-- Category, Condition, Weight -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-folder me-2 text-warning"></i>{{ form.category.label.text }}
                                    </label>
                                    {{ form.category(class="form-select form-select-lg") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-star me-2 text-warning"></i>{{ form.condition.label.text }}
                                    </label>
                                    {{ form.condition(class="form-select form-select-lg") }}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label fw-bold">
                                        <i class="fas fa-weight me-2 text-secondary"></i>{{ form.weight.label.text }}
                                    </label>
                                    <div class="input-group input-group-lg">
                                        {{ form.weight(class="form-control", placeholder="0.5", step="0.001") }}
                                        <span class="input-group-text">kg</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Description -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-align-left me-2 text-primary"></i>{{ form.description.label.text }}
                                    <span class="text-danger">*</span>
                                </label>
                                {{ form.description(class="form-control", rows="5", placeholder="Descrivi il tuo prodotto in dettaglio: caratteristiche, stato di conservazione, motivo della vendita, accessori inclusi...", id="field-description") }}
                                <div class="invalid-feedback d-none" id="error-description">
                                    Errore descrizione
                                </div>
                                <div class="valid-feedback d-none" id="success-description">
                                    <i class="fas fa-check me-1"></i>Descrizione completa!
                                </div>
                                <div class="form-text">
                                    <span id="charCount">0</span>/1000 caratteri - Una descrizione dettagliata aumenta le vendite
                                </div>
                            </div>

                            <!-- Image Upload -->
                            <!-- NOTA: L'etichetta "Immagine Prodotto:" viene da app/forms.py -->
                            <!-- Classe AddItemForm, campo: image = FileField(label='Immagine Prodotto:', ...) -->
                            <!-- Per modificare il testo, cambia il 'label' nel file forms.py -->
                            <div class="mb-4">
                                <label class="form-label fw-bold">
                                    <i class="fas fa-camera me-2 text-success"></i>{{ form.image.label.text }}
                                </label>
                                <div class="image-upload-container">
                                    <div class="image-upload-area" id="imageUploadArea">
                                        <div class="upload-content">
                                            <i class="fas fa-cloud-upload-alt text-primary mb-3" style="font-size: 3rem;"></i>
                                            <h5 class="fw-bold">Carica un'immagine del prodotto</h5>
                                            <p class="text-muted mb-3">Trascina qui il file o clicca per selezionare</p>
                                            {{ form.image(class="form-control d-none", accept="image/*", id="imageInput") }}
                                            <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                                                <i class="fas fa-plus me-2"></i>Scegli File
                                            </button>
                                            <div class="mt-2">
                                                <small class="text-muted">JPG, PNG, GIF (max 5MB)</small>
                                            </div>
                                        </div>
                                        <div class="image-preview d-none" id="imagePreview">
                                            <img id="previewImg" src="" alt="Preview" class="img-fluid rounded">
                                            <div class="preview-overlay">
                                                <button type="button" class="btn btn-sm btn-danger" onclick="removeImage()">
                                                    <i class="fas fa-trash"></i> Rimuovi
                                                </button>
                                                <button type="button" class="btn btn-sm btn-secondary" onclick="document.getElementById('imageInput').click()">
                                                    <i class="fas fa-edit"></i> Cambia
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Submit Buttons -->
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.submit(class='btn btn-primary btn-lg w-100', style="height: 60px;") }}
                                </div>
                                <div class="col-md-6">
                                    <a href="{{ url_for('market') }}" class="btn btn-outline-secondary btn-lg w-100" style="height: 60px; display: flex; align-items: center; justify-content: center;">
                                        <i class="fas fa-arrow-left me-2"></i>Torna al Market
                                    </a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <!-- Tips Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light border-0">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>Consigli per Vendere
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-start mb-3">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <strong>Foto di qualità</strong>
                                <p class="text-muted mb-0 small">Prodotti con foto vendono 3x più velocemente</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-start mb-3">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <strong>Prezzo competitivo</strong>
                                <p class="text-muted mb-0 small">Controlla prezzi simili nel market</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-start mb-3">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <strong>Descrizione completa</strong>
                                <p class="text-muted mb-0 small">Include tutti i dettagli importanti</p>
                            </div>
                        </div>
                        <div class="d-flex align-items-start">
                            <i class="fas fa-check-circle text-success me-3 mt-1"></i>
                            <div>
                                <strong>Categoria corretta</strong>
                                <p class="text-muted mb-0 small">Aiuta gli acquirenti a trovarti</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-light border-0">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-chart-line me-2 text-primary"></i>Statistiche Marketplace
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="row g-3">
                            <div class="col-6">
                                <div class="p-3 bg-primary bg-opacity-10 rounded">
                                    <h4 class="fw-bold text-primary mb-1">98%</h4>
                                    <small class="text-muted">Vendite completate</small>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="p-3 bg-success bg-opacity-10 rounded">
                                    <h4 class="fw-bold text-success mb-1">24h</h4>
                                    <small class="text-muted">Tempo medio vendita</small>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="p-3 bg-warning bg-opacity-10 rounded">
                                    <h4 class="fw-bold text-warning mb-1">1,500+</h4>
                                    <small class="text-muted">Prodotti venduti questo mese</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Security Card -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light border-0">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-shield-alt me-2 text-success"></i>Vendita Sicura
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-lock text-success me-2"></i>
                            <small>Pagamenti protetti</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-user-shield text-success me-2"></i>
                            <small>Acquirenti verificati</small>
                        </div>
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-headset text-success me-2"></i>
                            <small>Supporto 24/7</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-undo text-success me-2"></i>
                            <small>Garanzia rimborso</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- VALIDAZIONE SEMPLIFICATA -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 Validazione semplificata avviata');
    
    // Campi da validare con i loro ID univoci
    const fields = {
        'name': {
            id: 'field-name',
            errorId: 'error-name', 
            successId: 'success-name',
            required: true,
            validate: (val) => val.length >= 2 ? null : 'Min 2 caratteri'
        },
        'price': {
            id: 'field-price',
            errorId: 'error-price',
            successId: 'success-price', 
            required: true,
            validate: (val) => {
                const n = parseFloat(val);
                if (isNaN(n) || n < 1) return 'Min $1';
                if (n > 10000) return 'Max $10,000';
                return null;
            }
        },
        'barcode': {
            id: 'field-barcode',
            errorId: 'error-barcode',
            successId: 'success-barcode',
            required: true, 
            validate: (val) => /^\d{12}$/.test(val) ? null : 'Esattamente 12 cifre'
        },
        'description': {
            id: 'field-description',
            errorId: 'error-description',
            successId: 'success-description',
            required: true,
            validate: (val) => val.length >= 10 ? null : 'Min 10 caratteri'
        }
    };
    
    // Funzione per aggiornare un campo
    function updateField(fieldName, isValid, errorMsg = '') {
        const field = fields[fieldName];
        const input = document.getElementById(field.id);
        const errorDiv = document.getElementById(field.errorId);
        const successDiv = document.getElementById(field.successId);
        
        if (!input) return;
        
        // Reset
        input.classList.remove('is-valid', 'is-invalid');
        if (errorDiv) {
            errorDiv.classList.add('d-none');
            errorDiv.textContent = '';
        }
        if (successDiv) successDiv.classList.add('d-none');
        
        // Applica stato
        if (input.value.trim() !== '') {
            if (isValid) {
                input.classList.add('is-valid');
                if (successDiv) successDiv.classList.remove('d-none');
            } else {
                input.classList.add('is-invalid');
                if (errorDiv) {
                    errorDiv.textContent = errorMsg;
                    errorDiv.classList.remove('d-none');
                }
            }
        }
    }
    
    // Setup validazione per ogni campo
    Object.keys(fields).forEach(fieldName => {
        const field = fields[fieldName];
        const input = document.getElementById(field.id);
        
        if (input) {
            input.addEventListener('input', function() {
                const error = field.validate(this.value);
                updateField(fieldName, error === null, error);
                
                // Contatore caratteri per descrizione
                if (fieldName === 'description') {
                    const counter = document.getElementById('charCount');
                    if (counter) counter.textContent = this.value.length;
                }
            });
            
            input.addEventListener('blur', function() {
                if (this.value.trim() !== '') {
                    const error = field.validate(this.value);
                    updateField(fieldName, error === null, error);
                }
            });
        }
    });
    
    // Submit validation
    const form = document.getElementById('productForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            let allValid = true;
            const errors = [];
            
            // Valida tutti i campi
            Object.keys(fields).forEach(fieldName => {
                const field = fields[fieldName];
                const input = document.getElementById(field.id);
                
                if (input) {
                    const error = field.validate(input.value);
                    const isValid = error === null;
                    
                    updateField(fieldName, isValid, error);
                    
                    if (!isValid) {
                        allValid = false;
                        errors.push(error);
                    }
                }
            });
            
                         if (allValid) {
                 // Submit ok
                 const btn = form.querySelector('button[type="submit"]');
                 btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Pubblicando...';
                 btn.disabled = true;
                 
                 // Toast di conferma
                 if (typeof window.toast !== 'undefined') {
                     window.toast.info('🚀 Pubblicazione in corso...');
                 }
                 
                 setTimeout(() => form.submit(), 100);
             } else {
                 // Toast di errore moderno
                 if (typeof window.toast !== 'undefined') {
                     window.toast.error(`❌ Correggi ${errors.length} errori nei campi obbligatori`);
                 }
                 
                 // Focus primo campo invalido
                 const firstInvalid = form.querySelector('.is-invalid');
                 if (firstInvalid) firstInvalid.focus();
             }
        });
    }
    
    // Image upload semplificato
    const imageInput = document.getElementById('imageInput');
    if (imageInput) {
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const file = this.files[0];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const preview = document.getElementById('previewImg');
                        const uploadContent = document.querySelector('.upload-content');
                        const previewContainer = document.getElementById('imagePreview');
                        
                        if (preview && uploadContent && previewContainer) {
                            preview.src = e.target.result;
                            uploadContent.classList.add('d-none');
                            previewContainer.classList.remove('d-none');
                        }
                    };
                    reader.readAsDataURL(file);
                }
            }
        });
    }
});

function removeImage() {
    const imageInput = document.getElementById('imageInput');
    const uploadContent = document.querySelector('.upload-content');
    const previewContainer = document.getElementById('imagePreview');
    
    if (imageInput) imageInput.value = '';
    if (uploadContent) uploadContent.classList.remove('d-none');
    if (previewContainer) previewContainer.classList.add('d-none');
}
</script>

{% endblock content %} 