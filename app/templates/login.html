{% extends 'base.html' %} 

{% block title%} 
Accedi - La Casa
{% endblock%} 

{% block content %}

<!-- Clean Login Section -->
<div class="container-fluid" style="background: #f8f9fa; min-height: 100vh;">
  <div class="container py-5">
    <div class="row justify-content-center">
      <div class="col-lg-4 col-md-6">
        
        <!-- Simple Login Card -->
        <div class="card shadow-sm border-0">
          
          <!-- Card Header -->
          <div class="card-header bg-white text-center py-4 border-0">
            <div class="mb-3">
              <i class="fas fa-store text-primary" style="font-size: 2.5rem;"></i>
            </div>
            <h2 class="mb-2 text-dark" style="font-weight: 600; font-size: 1.5rem;">Accedi</h2>
            <p class="text-muted mb-0">Inserisci le tue credenziali</p>
          </div>
          
          <!-- Card Body -->
          <div class="card-body p-4">
            <form method="POST" novalidate id="loginForm">
              {{ form.hidden_tag() }}
              
              <!-- Username Field -->
              <div class="mb-3">
                <label for="{{ form.username.id }}" class="form-label text-dark">
                  Username
                </label>
                {{ form.username(class="form-control", placeholder="Inserisci il tuo username") }}
                {% if form.username.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.username.errors %}
                      <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Password Field -->
              <div class="mb-3">
                <label for="{{ form.password.id }}" class="form-label text-dark">
                  Password
                </label>
                <div class="input-group">
                  {{ form.password(class="form-control", placeholder="Inserisci la tua password") }}
                  <button type="button" class="btn btn-outline-secondary password-toggle" onclick="togglePassword()">
                    <i class="fas fa-eye" id="toggleIcon"></i>
                  </button>
                </div>
                <div id="password-error-container"></div>
                {% if form.password.errors %}
                  <div class="invalid-feedback d-block">
                    {% for error in form.password.errors %}
                      <small class="text-danger">{{ error }}</small>
                    {% endfor %}
                  </div>
                {% endif %}
              </div>
              
              <!-- Remember Me & Forgot Password -->
              <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="rememberMe">
                  <label class="form-check-label text-muted" for="rememberMe">
                    Ricordami
                  </label>
                </div>
                <a href="#" class="text-decoration-none text-primary">
                  Password dimenticata?
                </a>
              </div>
              
              <!-- Submit Button -->
              <div class="d-grid mb-3">
                {{ form.submit(class="btn btn-primary btn-lg") }}
              </div>
              
              <!-- Register Link -->
              <div class="text-center">
                <p class="text-muted mb-0">
                  Non hai un account? 
                  <a href="{{ url_for('register_page') }}" class="text-decoration-none text-primary">
                    Registrati
                  </a>
                </p>
              </div>
              
            </form>
          </div>
          
        </div>
        
      </div>
    </div>
  </div>
</div>

<!-- JavaScript per funzionalità interattive -->
<script>
// Toggle password visibility
function togglePassword() {
  const passwordField = document.querySelector('input[name="password"]');
  const toggleIcon = document.getElementById('toggleIcon');
  
  // Prevent validation when toggling
  passwordField.setAttribute('data-toggling', 'true');
  
  if (passwordField.type === 'password') {
    passwordField.type = 'text';
    toggleIcon.classList.remove('fa-eye');
    toggleIcon.classList.add('fa-eye-slash');
  } else {
    passwordField.type = 'password';
    toggleIcon.classList.remove('fa-eye-slash');
    toggleIcon.classList.add('fa-eye');
  }
  
  // Remove the flag after a short delay
  setTimeout(() => {
    passwordField.removeAttribute('data-toggling');
  }, 100);
}

// Form validation and UX enhancements
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('loginForm');
  const submitBtn = form.querySelector('button[type="submit"]');
  const inputs = form.querySelectorAll('input[type="text"], input[type="password"]');
  
  // Validation only on blur (when user finishes typing)
  inputs.forEach(input => {
    input.addEventListener('blur', function() {
      // Don't validate if user is just toggling password visibility
      if (this.getAttribute('data-toggling') === 'true') {
        return;
      }
      validateField(this);
    });
  });
  
  // Form submission with loading state
  form.addEventListener('submit', function(e) {
    if (validateForm()) {
      showLoadingState();
    }
  });
  
  function validateField(field) {
    const value = field.value.trim();
    const fieldName = field.name;
    let isValid = true;
    let errorMessage = '';
    
    // Remove existing error styling
    field.classList.remove('is-invalid');
    const existingError = field.parentNode.querySelector('.field-error');
    if (existingError) {
      existingError.remove();
    }
    
    // Validation rules
    if (fieldName === 'username') {
      if (value.length === 0) {
        isValid = false;
        errorMessage = 'Username è richiesto';
      } else if (value.length < 3) {
        isValid = false;
        errorMessage = 'Username deve essere di almeno 3 caratteri';
      }
    } else if (fieldName === 'password') {
      if (value.length === 0) {
        isValid = false;
        errorMessage = 'Password è richiesta';
      } else if (value.length < 6) {
        isValid = false;
        errorMessage = 'Password deve essere di almeno 6 caratteri';
      }
    }
    
    // Show error if invalid
    if (!isValid) {
      field.classList.add('is-invalid');
      showFieldError(field, errorMessage);
    } else {
      field.classList.add('is-valid');
    }
    
    return isValid;
  }
  
  function validateForm() {
    let isFormValid = true;
    inputs.forEach(input => {
      if (!validateField(input)) {
        isFormValid = false;
      }
    });
    return isFormValid;
  }
  
  function showFieldError(field, message) {
    // Remove existing error
    const existingError = field.parentNode.querySelector('.field-error');
    if (existingError) {
      existingError.remove();
    }
    
    // For password field, use specific container
    let container;
    if (field.name === 'password') {
      container = document.getElementById('password-error-container');
    } else {
      container = field.parentNode;
    }
    
    const errorDiv = document.createElement('div');
    errorDiv.className = 'field-error text-danger mt-1';
    errorDiv.style.fontSize = '0.875rem';
    errorDiv.textContent = message;
    container.appendChild(errorDiv);
  }
  
  function showLoadingState() {
    form.classList.add('form-loading');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Accesso in corso...';
  }
  
  // Add focus effects
  inputs.forEach(input => {
    input.addEventListener('focus', function() {
      this.parentNode.classList.add('focused');
    });
    
    input.addEventListener('blur', function() {
      this.parentNode.classList.remove('focused');
    });
  });
  
  // Add enter key support
  inputs.forEach(input => {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        const nextInput = this.parentNode.nextElementSibling?.querySelector('input');
        if (nextInput) {
          nextInput.focus();
        } else {
          form.submit();
        }
      }
    });
  });
});

// Add CSS for focus effects
const style = document.createElement('style');
style.textContent = `
  .focused .form-control {
    transform: translateY(-2px);
    box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.1);
  }
  
  .is-valid {
    border-color: var(--accent-green) !important;
  }
  
  .is-invalid {
    border-color: var(--accent-red) !important;
    animation: errorShake 0.5s ease-in-out;
  }
`;
document.head.appendChild(style);
</script>

{% endblock content %}